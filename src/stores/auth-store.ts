'use client'

import { create } from 'zustand'
import { supabase } from '@/lib/supabase'
import { AuthState, User, Company } from '@/lib/types'

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  company: null,
  isLoading: true,

  initialize: async () => {
    console.log('üîÑ Initializing authentication...')
    try {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession()
      
      if (sessionError) {
        console.error('‚ùå Session error:', sessionError)
        set({ user: null, company: null, isLoading: false })
        return
      }
      
      if (session?.user) {
        console.log('‚úÖ Session found for user:', session.user.id)
        
        // Get user profile
        const { data: profile, error: profileError } = await supabase
          .from('users')
          .select('*')
          .eq('id', session.user.id)
          .single()

        if (profileError) {
          console.error('‚ùå Profile fetch error:', profileError)
          console.log('üîç User ID:', session.user.id)
          console.log('üîç User Email:', session.user.email)
          
          // If profile doesn't exist, just log it (don't redirect automatically)
          if (profileError.code === 'PGRST116') {
            console.log('‚ö†Ô∏è No profile found - user should complete registration')
            set({ user: null, company: null, isLoading: false })
            return
          }
          
          set({ user: null, company: null, isLoading: false })
          return
        }

        if (profile) {
          console.log('‚úÖ Profile found:', profile)
          
          // Get company information (only if user has a company_id)
          let company = null
          if (profile.company_id) {
            console.log('üîÑ Fetching company data for ID:', profile.company_id)
            const { data: companyData, error: companyError } = await supabase
              .from('companies')
              .select('*')
              .eq('id', profile.company_id)
              .single()

            if (companyError) {
              console.error('‚ùå Company fetch error:', companyError)
              console.log('üîç Company ID:', profile.company_id)
              // Still proceed without company for now
            } else {
              company = companyData
              console.log('‚úÖ Company found:', company)
            }
          } else {
            console.log('‚ö†Ô∏è User has no company_id - company setup required')
          }

          set({ 
            user: profile as User, 
            company: company as Company,
            isLoading: false 
          })
          console.log('‚úÖ Authentication complete')
        } else {
          console.log('‚ùå No profile found for user')
          set({ user: null, company: null, isLoading: false })
        }
      } else {
        console.log('‚ÑπÔ∏è No active session')
        set({ user: null, company: null, isLoading: false })
      }
    } catch (error) {
      console.error('‚ùå Auth initialization error:', error)
      set({ user: null, company: null, isLoading: false })
    }
  },

  signIn: async (email: string, password: string) => {
    console.log('üîÑ Signing in user:', email)
    set({ isLoading: true })
    
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      })

      if (error) {
        console.error('‚ùå Sign in error:', error)
        throw error
      }

      console.log('‚úÖ Sign in successful for user:', data.user.id)

      // Get user profile
      const { data: profile, error: profileError } = await supabase
        .from('users')
        .select('*')
        .eq('id', data.user.id)
        .single()

      if (profileError) {
        console.error('‚ùå Profile fetch error after sign in:', profileError)
        console.log('üîç User ID:', data.user.id)
        console.log('üîç User Email:', data.user.email)
        
        if (profileError.code === 'PGRST116') {
          set({ isLoading: false })
          throw new Error('Profile not found. Please complete your registration by creating a new account.')
        }
        
        set({ isLoading: false })
        throw new Error('Profile not found. Please contact support.')
      }

      if (profile) {
        console.log('‚úÖ Profile found after sign in:', profile)
        
        // Get company information (only if user has a company_id)
        let company = null
        if (profile.company_id) {
          const { data: companyData, error: companyError } = await supabase
            .from('companies')
            .select('*')
            .eq('id', profile.company_id)
            .single()

          if (companyError) {
            console.error('‚ùå Company fetch error after sign in:', companyError)
          } else {
            company = companyData
            console.log('‚úÖ Company found after sign in:', company)
          }
        }

        set({ 
          user: profile as User, 
          company: company as Company,
          isLoading: false 
        })
        console.log('‚úÖ Sign in process complete')
      }
    } catch (error) {
      console.error('‚ùå Sign in process failed:', error)
      set({ isLoading: false })
      throw error
    }
  },

  signUp: async (email: string, password: string, fullName: string, role: User['role'], companyName?: string) => {
    console.log('üîÑ Starting sign up process for:', email)
    set({ isLoading: true })
    
    try {
      console.log('üìß Creating auth user...')
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
      })

      if (error) {
        console.error('‚ùå Auth signup error:', error)
        console.error('‚ùå Auth error details:', JSON.stringify(error, null, 2))
        console.error('‚ùå Auth error message:', error?.message)
        console.error('‚ùå Auth error code:', error?.code)
        throw error
      }

      console.log('‚úÖ Auth user created:', data.user?.id)

      if (data.user) {
        let companyId = ''

        // Create user profile first (without company)
        console.log('üë§ Creating user profile...')
        const profileData = {
          id: data.user.id,
          email: data.user.email!,
          full_name: fullName,
          role,
          company_id: null, // Will be updated after company creation
        }
        console.log('üìù Profile data:', profileData)

        const { error: profileError } = await supabase
          .from('users')
          .insert(profileData)

        if (profileError) {
          console.error('‚ùå Profile creation error:', profileError)
          console.error('‚ùå Profile error details:', JSON.stringify(profileError, null, 2))
          console.error('‚ùå Profile error message:', profileError?.message)
          console.error('‚ùå Profile error code:', profileError?.code)
          console.error('‚ùå Profile error hint:', profileError?.hint)
          throw new Error(`Profile creation failed: ${profileError?.message || profileError?.code || 'Unknown error'}`)
        }

        console.log('‚úÖ Profile created successfully')

        // Now create company if owner role and company name provided
        if (role === 'owner' && companyName) {
          console.log('üè¢ Creating company:', companyName)

          const { data: companyData, error: companyError } = await supabase
            .from('companies')
            .insert({ name: companyName })
            .select()
            .single()

          if (companyError) {
            console.error('‚ùå Company creation error:', companyError)
            console.error('‚ùå Company error details:', JSON.stringify(companyError, null, 2))
            console.error('‚ùå Company error message:', companyError?.message)
            console.error('‚ùå Company error code:', companyError?.code)
            console.error('‚ùå Company error hint:', companyError?.hint)
            throw new Error(`Company creation failed: ${companyError?.message || companyError?.code || 'Unknown error'}`)
          }
          
          companyId = companyData.id
          console.log('‚úÖ Company created:', companyId)

          // Auto-apply builder preset stages for new company
          console.log('üèóÔ∏è Auto-applying builder preset stages...')
          try {
            const stageSetupResponse = await fetch(`/api/companies/${companyId}/setup-stages`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                created_by_user_id: data.user.id
              })
            })

            if (stageSetupResponse.ok) {
              const setupResult = await stageSetupResponse.json()
              console.log('‚úÖ Builder preset stages applied successfully:', setupResult)
            } else {
              const errorResult = await stageSetupResponse.json()
              console.error('‚ö†Ô∏è Failed to auto-apply builder preset:', errorResult)
              // Don't throw error - company creation should still succeed
            }
          } catch (stageSetupError) {
            console.error('‚ö†Ô∏è Stage setup request failed:', stageSetupError)
            // Don't throw error - company creation should still succeed
          }

          // Update user profile with company_id
          const { error: updateError } = await supabase
            .from('users')
            .update({ company_id: companyId })
            .eq('id', data.user.id)

          if (updateError) {
            console.error('‚ùå Profile update error:', updateError)
            console.error('‚ùå Update error details:', JSON.stringify(updateError, null, 2))
            // Don't throw here - profile exists, just missing company link
            console.log('‚ö†Ô∏è User profile created but company link failed')
          } else {
            console.log('‚úÖ Profile updated with company ID')
          }
        }

        console.log('‚úÖ Registration process completed successfully')
        set({ isLoading: false })
      }
    } catch (error) {
      console.error('‚ùå Sign up process failed:', error)
      console.error('‚ùå Error details:', JSON.stringify(error, null, 2))
      console.error('‚ùå Error message:', (error as any)?.message)
      console.error('‚ùå Error code:', (error as any)?.code)
      set({ isLoading: false })
      throw error
    }
  },

  signOut: async () => {
    try {
      await supabase.auth.signOut()
      set({ user: null, company: null, isLoading: false })
    } catch (error) {
      console.error('Sign out error:', error)
    }
  },

  createProfile: async (fullName: string, role: User['role'], companyName?: string) => {
    console.log('üîÑ Creating profile for existing user...')
    set({ isLoading: true })
    
    try {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession()
      
      if (sessionError || !session?.user) {
        throw new Error('No active session found')
      }

      let companyId = ''

      // Create company if owner role and company name provided
      if (role === 'owner' && companyName) {
        const { data: companyData, error: companyError } = await supabase
          .from('companies')
          .insert({ name: companyName })
          .select()
          .single()

        if (companyError) throw companyError
        companyId = companyData.id
        
        // Auto-apply builder preset stages for new company
        console.log('üèóÔ∏è Auto-applying builder preset stages...')
        try {
          const stageSetupResponse = await fetch(`/api/companies/${companyId}/setup-stages`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              created_by_user_id: session.user.id
            })
          })

          if (stageSetupResponse.ok) {
            const setupResult = await stageSetupResponse.json()
            console.log('‚úÖ Builder preset stages applied successfully:', setupResult)
          } else {
            const errorResult = await stageSetupResponse.json()
            console.error('‚ö†Ô∏è Failed to auto-apply builder preset:', errorResult)
            // Don't throw error - company creation should still succeed
          }
        } catch (stageSetupError) {
          console.error('‚ö†Ô∏è Stage setup request failed:', stageSetupError)
          // Don't throw error - company creation should still succeed
        }
      }

      // Create user profile
      const { data: profile, error: profileError } = await supabase
        .from('users')
        .insert({
          id: session.user.id,
          email: session.user.email!,
          full_name: fullName,
          role,
          company_id: companyId,
        })
        .select()
        .single()

      if (profileError) throw profileError

      console.log('‚úÖ Profile created successfully:', profile)
      
      // Initialize the user session with new profile
      await useAuthStore.getState().initialize()
      
    } catch (error) {
      console.error('‚ùå Profile creation failed:', error)
      set({ isLoading: false })
      throw error
    }
  },
}))

// Auth state change listener
supabase.auth.onAuthStateChange((event, session) => {
  console.log('üîÑ Auth state change:', event, session?.user?.id)
  
  if (event === 'SIGNED_OUT') {
    useAuthStore.getState().signOut()
  } else if (event === 'SIGNED_IN' && session) {
    useAuthStore.getState().initialize()
  }
})